(function(e){require.config({paths:{d3:"https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min"}});define(["d3"],function(t){return e({},t)})})(function(e,t){t.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};t.selection.prototype.moveToBack=function(){return this.each(function(){var e=this.parentNode.firstChild;if(e){this.parentNode.insertBefore(this,e)}})};var n={neuron:{colors:{input:"#00A000",hidden:"#0000C7",output:"#F6BD00",bias:"#8F686F"},mouseon:{change_radius:2,alpha:.2}},synapse:{colors:{negative:"#00005E",positive:"#5E0000"},default_width_range:[.5,2],width_range:[.5,2],default_alpha:.7,alpha:.7,mouseon:{width_range:[.5,10],alpha:.1}},variables:{labels_layer0_padding:.03},legend:{pos:{x:150,y:10},rect:{width:10,height:10},dy:20,padding:10}};var a;var r=function(e,t){return Number(Object.keys(e["layout"]["layer_"+t]).length-1)};var s=function(e,t,n){var s=r(e,n);var i=Array(s);for(var o=0;o<s;o++){i[o]={position:{x:(n+.5)*a.width/t,y:(o+.5)*a.height/s},radius:a.height/(s+(s>5?0:5))/4,type:o==s-1?"bias":n==0?"input":"hidden",neuron:o,layer:n};if(n==t-1){i[o]["type"]="output"}}return i};var i=function(e,t,n){var n=e["layout"]["layer_"+t]["neuron_"+n];if(n["nsynapses"]!=0)return n["weights"];return[]};var o=function(e,n){var a=-1e30;var s=1e30;var o;for(var l=0;l<n;l++){for(var p=0;p<r(e,l);p++){o=t.max(i(e,l,p));if(a<o)a=o;o=t.min(i(e,l,p));if(s>o)s=o}}return{min:s,max:a}};var l=function(e,t,n,a,r){var s=i(e,t,n);var o=Array(s.length);for(var l in s){o[l]={layer:t,neuron:n,nextlayer_neuron:l,pos:[a,r[l].position],weight:s[l],type:s[l]<0?"negative":"positive"}}return o};var p=function(e,t){var r=e["variables"];r.push("Bias node");var s=Array(r.length);for(var i in t){s[i]={x:t[i].position.x-n["variables"]["labels_layer0_padding"]*a.width,y:t[i].position.y,text:r[i]+":"}}return s};var u=function(e){e.append("text").text(function(e){return e[1].text}).attr("x",function(e){return e[1].x-this.getComputedTextLength()}).attr("y",function(e){return e[1].y+.25*this.getBBox().height})};var h=function(e,a,r,s,i,o){if(i!==undefined){var l=t.zip(r,p(a,r))}else{var l=t.zip(r,Array(r.length))}var h=e.append("g").attr("id","layer_"+s).attr("class","layer").selectAll("g").data(l).enter().append("g").attr("id",function(e){return"neuron_"+s+""+e[0].neuron});h.append("circle").attr("r",function(e){return e[0].radius}).attr("cx",function(e){return e[0].position.x}).attr("cy",function(e){return e[0].position.y}).style("fill",function(e){return n["neuron"]["colors"][e[0].type]});if(i!==undefined){u(h)}if(o)return;g(e,h)};var c=t.scale.linear();var y=t.scale.linear();var d=t.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate("linear");var f=function(e,t,a,r,s){for(var i in a){var o=l(t,r,i,a[i].position,s);e.select("g#neuron_"+r+""+i).selectAll("path").data(o).enter().append("path").moveToBack().attr("d",function(e){return d(e.pos)}).attr("stroke",function(e){return n["synapse"]["colors"][e.type]}).attr("stroke-width",function(e){return e.type=="positive"?c(e.weight):y(Math.abs(e.weight))}).attr("stroke-opacity",n["synapse"]["alpha"])}};var g=function(e,a){n.synapse.width_range=Object.assign({},n.synapse.default_width_range);n.synapse.alpha=Object.assign({},n.synapse.default_alpha);a.on("mouseover",function(a){c.range(n["synapse"]["mouseon"]["width_range"]);y.range(n["synapse"]["mouseon"]["width_range"]);var r=t.select(this).moveToFront().transition();r.selectAll("path").style("stroke-opacity",1).attr("stroke-width",function(e){return e.type=="positive"?c(e.weight):y(Math.abs(e.weight))});r.selectAll("circle").style("fill-opacity",1).attr("r",function(e){return e[0].radius*n["neuron"]["mouseon"]["change_radius"]});r.selectAll("text").attr("x",function(e){return e[1].x-e[0].radius-this.getComputedTextLength()});var s=e.selectAll("g.layer").selectAll("g").filter(function(e){return!(a[0].neuron==e[0].neuron&&a[0].layer==e[0].layer)}).transition();s.selectAll("circle").filter(function(e){return a[0].layer+1!=e[0].layer}).style("fill-opacity",n["neuron"]["mouseon"]["alpha"]).attr("r",function(e){return e[0].radius});s.selectAll("path").style("stroke-opacity",n["synapse"]["mouseon"]["alpha"])});a.on("mouseout",function(t){c.range(n["synapse"]["width_range"]);y.range(n["synapse"]["width_range"]);var a=e.selectAll("g.layer").selectAll("g").transition();a.selectAll("circle").style("fill-opacity",1).attr("r",function(e){return e[0].radius});a.selectAll("path").style("stroke-opacity",n["synapse"]["alpha"]).attr("stroke-width",function(e){return e.type=="positive"?c(e.weight):y(Math.abs(e.weight))});a.selectAll("text").attr("x",function(e){return e[1].x-this.getComputedTextLength()})})};var v=function(e){var r=[{c:n["synapse"]["colors"]["positive"],txt:"Positive weight"},{c:n["synapse"]["colors"]["negative"],txt:"Negative weight"}];var s=n["legend"];var i=e.append("g").attr("id","legend");i.selectAll("g").data(r).enter().append("g").each(function(e,n){var r=t.select(this);r.append("rect").attr("x",a.width-s.pos.x).attr("y",s.pos.y+n*s.dy).attr("width",s.rect.width).attr("height",s.rect.height).style("fill",function(e){return e.c});r.append("text").attr("x",a.width-s.pos.x+s.rect.width+s.padding).attr("y",s.pos.y+n*s.dy+s.rect.height).text(function(e){return e.txt}).style("fill",function(e){return e.c})})};e.draw=function(r,i){if("layers"in i&&"synapses"in i)return e.drawDeepNetwork(r,i);var l,p;var u=t.select("#"+r);a={width:u.property("style")["width"],height:u.property("style")["height"]};console.log(i);var d;if("layers"in i&&"synapses"in i){p=w(i);n.synapse.width_range=[5/i["synapses"]["synapses"].length,50/i["synapses"]["synapses"].length];n.synapse.alpha=.9;c.range(n["synapse"]["width_range"]);y.range(n["synapse"]["width_range"]);d=true}else{p=i;n.synapse.width_range=Object.assign({},n.synapse.default_width_range);n.synapse.alpha=Object.assign({},n.synapse.default_alpha);c.range(n["synapse"]["width_range"]);y.range(n["synapse"]["width_range"]);d=false}l=u.append("svg").attr("id","svg_"+r).attr("width",a.width).attr("height",a.height);Object.keys(a).forEach(function(e){a[e]=Number(a[e].replace("px",""))});var g=Number(p["layout"]["nlayers"]);c.domain([0,o(p,g).max]);y.domain([0,Math.abs(o(p,g).min)]);var m=t.behavior.zoom().scaleExtent([1,20]).on("zoom",function(){l.attr("transform","translate("+t.event.translate+")scale("+t.event.scale+")")});l=l.on("dblclick",function(){m.scale(1);m.translate([0,0]);l.transition().attr("transform","translate(0,0)scale(1)")}).append("g").call(m).append("g");var _=Array(g);for(var x=0;x<g;x++){_[x]=s(p,g,x)}for(x=0;x<g;x++){h(l,p,_[x],x,x==0?true:undefined,d);f(l,p,_[x],x,_[x+1])}v(l)};var w=function(e){vars=e["variables"];vars.push("Bias node");var t=e["layers"];var n=e["synapses"]["synapses"];var a={layer_0:{nneurons:vars.length}};var r;for(var s=0;s<vars.length;s++){r=Number(t[0]["Nodes"]);a["layer_0"]["neuron_"+s]={nsynapses:r,weights:n.slice(s*r,(s+1)*r)}}for(var i=0;i<t.length-1;i++){a["layer_"+(i+1)]={nneurons:Number(t[i]["Nodes"])};r=Number(t[i+1]["Nodes"]);for(var s=0;s<Number(t[i]["Nodes"]);s++){a["layer_"+(i+1)]["neuron_"+s]={nsynapses:r,weights:n.slice(s*r,(s+1)*r)}}}a["layer_"+(i+1)]={nneurons:Number(t[i]["Nodes"])};for(var s=0;s<Number(t[i]["Nodes"]);s++){a["layer_"+(i+1)]["neuron_"+s]={nsynapses:0}}a["nlayers"]=i+2;var o={variables:vars,layout:a};return o};var m=function(e,t){for(var a=0;a<t.length;a++){e.beginPath();e.arc(t[a].position.x,t[a].position.y,t[a].radius,0,2*Math.PI);e.fillStyle=n["neuron"]["colors"][t[a].type];e.fill();e.closePath()}};var _=function(e,t,a,r,s){var i,o,p;for(i in a){var u=l(t,r,i,a[i].position,s);for(o in u){p=u[o];e.beginPath();e.moveTo(p.pos[0].x,p.pos[0].y);e.lineTo(p.pos[1].x,p.pos[1].y);e.lineWidth=p.type=="positive"?c(p.weight):y(Math.abs(p.weight));e.strokeStyle=n["synapse"]["colors"][p.type];e.stroke();e.closePath()}}};e.drawDeepNetwork=function(e,r){var i=t.select("#"+e);a={width:i.property("style")["width"],height:i.property("style")["height"]};var o=50;r["layers"].splice(1,0,{Nodes:o});for(var l=0;l<100*o;l++){r["synapses"]["synapses"].push((Math.random()>.5?-1:1)*Math.random()*10)}for(var p=0;p<10;p++){r["layers"].splice(1,0,{Nodes:o});for(var l=0;l<o*o;l++){r["synapses"]["synapses"].push((Math.random()>.5?-1:1)*Math.random()*10)}}for(var l=0;l<o*50;l++){r["synapses"]["synapses"].push((Math.random()>.5?-1:1)*Math.random()*10)}net=w(r);n.synapse.width_range=[50/r["synapses"]["synapses"].length,1e3/r["synapses"]["synapses"].length];n.synapse.alpha=.9;c.range(n["synapse"]["width_range"]);y.range(n["synapse"]["width_range"]);var u=i.append("canvas").attr("width",a.width).attr("height",a.height).node().getContext("2d");Object.keys(a).forEach(function(e){a[e]=Number(a[e].replace("px",""))});var h=Number(net["layout"]["nlayers"]);var d=Array(h);for(var l=0;l<h;l++){d[l]=s(net,h,l)}for(l=0;l<h;l++){_(u,net,d[l],l,d[l+1]);m(u,d[l])}};Object.seal(e);return e});