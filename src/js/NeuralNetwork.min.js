(function(e){define(["d3"],function(t){return e({},t)})})(function(e,t){t.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};t.selection.prototype.moveToBack=function(){return this.each(function(){var e=this.parentNode.firstChild;if(e){this.parentNode.insertBefore(this,e)}})};var r={neuron:{colors:{input:"#00A000",hidden:"#0000C7",output:"#F6BD00",bias:"#8F686F"},mouseon:{change_radius:2,alpha:.2}},synapse:{colors:{negative:"#00005E",positive:"#FF4B00"},deepNet_colors:{negative:"rgba(0,0,94, 0.4)",positive:"rgba(94,0,0, 0.4)"},default_width_range:[.5,5],width_range:[.5,5],deepNet_default_width_range:[.5,2],deepNet_width_range:[.5,2],default_alpha:.7,alpha:.7,mouseon:{width_range:[.5,10],alpha:.1}},variables:{labels_layer0_padding:.03},legend:{pos:{x:150,y:10},rect:{width:10,height:10},dy:20,padding:10,deepNet_colors:{negative:"rgb(0,0,94)",positive:"rgb(94,0,0)"}}};var n;var a=function(e,t){return Number(Object.keys(e["layout"]["layer_"+t]).length-1)};var i=function(e,t,r){var i=a(e,r);var s=Array(i);for(var o=0;o<i;o++){s[o]={position:{x:(r+.5)*n.width/t,y:(o+.5)*n.height/i},radius:n.height/(i+(i>5?0:5))/4,type:o==i-1?"bias":r==0?"input":"hidden",neuron:o,layer:r};if(r==t-1){s[o]["type"]="output"}}return s};var s=function(e,t,r){var r=e["layout"]["layer_"+t]["neuron_"+r];if(r["nsynapses"]!=0)return r["weights"];return[]};var o=function(e,r){var n=-1e30;var i=1e30;var o;for(var l=0;l<r;l++){for(var u=0;u<a(e,l);u++){o=t.max(s(e,l,u));if(n<o)n=o;o=t.min(s(e,l,u));if(i>o)i=o}}return{min:i,max:n}};var l=function(e,t,r,n,a){var i=s(e,t,r);var o=Array(i.length);for(var l in i){o[l]={layer:t,neuron:r,nextlayer_neuron:l,pos:[n,a[l].position],weight:i[l],type:i[l]<0?"negative":"positive"}}return o};var u=function(e,t){var a=e["variables"];a.push("Bias node");var i=Array(a.length);for(var s in t){i[s]={x:t[s].position.x-r["variables"]["labels_layer0_padding"]*n.width,y:t[s].position.y,text:a[s]+":"}}return i};var p=function(e){e.append("text").text(function(e){return e[1].text}).attr("x",function(e){return e[1].x-this.getComputedTextLength()}).attr("y",function(e){return e[1].y+.25*this.getBBox().height})};var h=function(e,n,a,i,s){if(s!==undefined){var o=t.zip(a,u(n,a))}else{var o=t.zip(a,Array(a.length))}var l=e.append("g").attr("id","layer_"+i).attr("class","layer").selectAll("g").data(o).enter().append("g").attr("id",function(e){return"neuron_"+i+""+e[0].neuron});l.append("circle").attr("r",function(e){return e[0].radius}).attr("cx",function(e){return e[0].position.x}).attr("cy",function(e){return e[0].position.y}).style("fill",function(e){return r["neuron"]["colors"][e[0].type]});if(s!==undefined){p(l)}v(e,l)};var c=t.scale.linear();var d=t.scale.linear();var g=t.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate("linear");var y=function(e,t,n,a,i){for(var s in n){var o=l(t,a,s,n[s].position,i);e.select("g#neuron_"+a+""+s).selectAll("path").data(o).enter().append("path").moveToBack().attr("d",function(e){return g(e.pos)}).attr("stroke",function(e){return r["synapse"]["colors"][e.type]}).attr("stroke-width",function(e){return e.type=="positive"?c(e.weight):d(Math.abs(e.weight))}).attr("stroke-opacity",r["synapse"]["alpha"])}};var v=function(e,n){r.synapse.width_range=Object.assign({},r.synapse.default_width_range);r.synapse.alpha=Object.assign({},r.synapse.default_alpha);n.on("mouseover",function(n){c.range(r["synapse"]["mouseon"]["width_range"]);d.range(r["synapse"]["mouseon"]["width_range"]);var a=t.select(this).moveToFront().transition();a.selectAll("path").style("stroke-opacity",1).attr("stroke-width",function(e){return e.type=="positive"?c(e.weight):d(Math.abs(e.weight))});a.selectAll("circle").style("fill-opacity",1).attr("r",function(e){return e[0].radius*r["neuron"]["mouseon"]["change_radius"]});a.selectAll("text").attr("x",function(e){return e[1].x-e[0].radius-this.getComputedTextLength()});var i=e.selectAll("g.layer").selectAll("g").filter(function(e){return!(n[0].neuron==e[0].neuron&&n[0].layer==e[0].layer)}).transition();i.selectAll("circle").filter(function(e){return n[0].layer+1!=e[0].layer}).style("fill-opacity",r["neuron"]["mouseon"]["alpha"]).attr("r",function(e){return e[0].radius});i.selectAll("path").style("stroke-opacity",r["synapse"]["mouseon"]["alpha"])});n.on("mouseout",function(t){c.range(r["synapse"]["width_range"]);d.range(r["synapse"]["width_range"]);var n=e.selectAll("g.layer").selectAll("g").transition();n.selectAll("circle").style("fill-opacity",1).attr("r",function(e){return e[0].radius});n.selectAll("path").style("stroke-opacity",1).attr("stroke-width",function(e){return e.type=="positive"?c(e.weight):d(Math.abs(e.weight))});n.selectAll("text").attr("x",function(e){return e[1].x-this.getComputedTextLength()})})};var f=function(e){var a=[{c:r["synapse"]["colors"]["positive"],txt:"Positive weight"},{c:r["synapse"]["colors"]["negative"],txt:"Negative weight"}];var i=r["legend"];var s=e.append("g").attr("id","legend");s.selectAll("g").data(a).enter().append("g").each(function(e,r){var a=t.select(this);a.append("rect").attr("x",n.width-i.pos.x).attr("y",i.pos.y+r*i.dy).attr("width",i.rect.width).attr("height",i.rect.height).style("fill",function(e){return e.c});a.append("text").attr("x",n.width-i.pos.x+i.rect.width+i.padding).attr("y",i.pos.y+r*i.dy+i.rect.height).text(function(e){return e.txt}).style("fill",function(e){return e.c})})};e.draw=function(a,s){if("layers"in s&&"synapses"in s)return e.drawDeepNetwork(a,s,true);if("layers"in s&&"Biases"in s["layers"][0])return e.drawDeepNetwork(a,s);var l,u;var p=t.select("#"+a);n={width:p.property("style")["width"],height:p.property("style")["height"]};u=s;r.synapse.width_range=Object.assign({},r.synapse.default_width_range);r.synapse.alpha=Object.assign({},r.synapse.default_alpha);c.range(r["synapse"]["width_range"]);d.range(r["synapse"]["width_range"]);l=p.append("svg").attr("id","svg_"+a).attr("width",n.width).attr("height",n.height);Object.keys(n).forEach(function(e){n[e]=Number(n[e].replace("px",""))});var g=Number(u["layout"]["nlayers"]);c.domain([0,o(u,g).max]);d.domain([0,Math.abs(o(u,g).min)]);var v=t.behavior.zoom().scaleExtent([1,20]).on("zoom",function(){l.attr("transform","translate("+t.event.translate+")scale("+t.event.scale+")")});l=l.on("dblclick",function(){v.scale(1);v.translate([0,0]);l.transition().attr("transform","translate(0,0)scale(1)")}).append("g").call(v).append("g");var w=Array(g);for(var _=0;_<g;_++){w[_]=i(u,g,_)}for(_=0;_<g;_++){h(l,u,w[_],_,_==0?true:undefined);y(l,u,w[_],_,w[_+1])}f(l)};var w=function(e){vars=e["variables"];var t=e["layers"];var r={layer_0:{nneurons:vars.length+1}};var n=Number(t[0]["Weights"]["row"]);for(var a=0;a<vars.length;a++){r["layer_0"]["neuron_"+a]={nsynapses:n,weights:t[0]["Weights"]["data"].slice(a*n,(a+1)*n)}}r["layer_0"]["neuron_"+vars.length]={nsynapses:Number(t[0]["Weights"]["row"]),weights:t[0]["Biases"]["data"]};vars.push("Bias node");for(var i=0;i<t.length-1;i++){r["layer_"+(i+1)]={nneurons:Number(t[i]["Weights"]["row"])+1};var s=Number(t[i]["Weights"]["row"]);n=Number(t[i+1]["Weights"]["row"]);for(var a=0;a<s;a++){r["layer_"+(i+1)]["neuron_"+a]={nsynapses:n,weights:t[i+1]["Weights"]["data"].slice(a*n,(a+1)*n)}}r["layer_"+(i+1)]["neuron_"+s]={nsynapses:Number(t[i]["Weights"]["row"]),weights:t[i+1]["Biases"]["data"]}}r["layer_"+(i+1)]={nneurons:Number(t[i]["Weights"]["row"])};for(var a=0;a<Number(t[i]["Weights"]["row"]);a++){r["layer_"+(i+1)]["neuron_"+a]={nsynapses:0}}r["nlayers"]=i+2;var o={variables:vars,layout:r};return o};var _=function(e,t,n){for(var a=0;a<t.length;a++){e.beginPath();e.arc(t[a].position.x+30,t[a].position.y,t[a].radius,0,2*Math.PI);e.fillStyle=r["neuron"]["colors"][t[a].type];e.fill();e.closePath()}if(n!==undefined){e.font="16px bold Comic Sans MS";e.fillStyle="#000";var i;for(var s=0;s<n.length;s++){i=n[s]+":";e.fillText(i,t[s].position.x+10-e.measureText(i).width,t[s].position.y+5)}}};var x=function(e,t,n,a,i){var s,o,u;for(s in n){var p=l(t,a,s,n[s].position,i);for(o in p){u=p[o];e.beginPath();e.moveTo(u.pos[0].x+30,u.pos[0].y);e.lineTo(u.pos[1].x+30,u.pos[1].y);e.lineWidth=u.type=="positive"?c(u.weight):d(Math.abs(u.weight));e.strokeStyle=r["synapse"]["deepNet_colors"][u.type];e.stroke();e.closePath()}}};var b=function(e,t){var r=Number(t["layout"]["nlayers"]);var n=Array(r);for(var a=0;a<r;a++){n[a]=i(t,r,a)}for(a=0;a<r;a++){x(e,t,n[a],a,n[a+1]);_(e,n[a],a==0?t["variables"]:undefined)}};var m=function(e){e.beginPath();e.fillStyle=r["legend"]["deepNet_colors"]["positive"];e.rect(n.width-170,10,r["legend"]["rect"]["width"],r["legend"]["rect"]["height"]);e.fill();e.closePath();e.beginPath();e.fillStyle=r["legend"]["deepNet_colors"]["negative"];e.rect(n.width-170,30,r["legend"]["rect"]["width"],r["legend"]["rect"]["height"]);e.fill();e.closePath();e.font="16px bold Comic Sans MS";e.fillStyle=r["legend"]["deepNet_colors"]["positive"];e.fillText("Positive weight",n.width-150,20);e.fillStyle=r["legend"]["deepNet_colors"]["negative"];e.fillText("Negative weight",n.width-150,40)};e.drawDeepNetwork=function(e,a,i){var s=t.select("#"+e);n={width:Number(s.property("style")["width"].replace("px","")),height:Number(s.property("style")["height"].replace("px",""))};net=w(a);c.range(r["synapse"]["deepNet_width_range"]);d.range(r["synapse"]["deepNet_width_range"]);var o=s.append("canvas").attr("width",n.width+"px").attr("height",n.height+"px").call(t.behavior.zoom().scaleExtent([1,20]).on("zoom",function(){o.save();o.clearRect(0,0,n.width,n.height);o.translate(t.event.translate[0],t.event.translate[1]);o.scale(t.event.scale,t.event.scale);b(o,net);m(o);o.restore()})).node().getContext("2d");b(o,net);m(o)};Object.seal(e);return e});