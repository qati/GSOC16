(function(e){var t=require.toUrl("./NetworkDesigner.js");t=t.substr(0,t.lastIndexOf("/")+1);require.config({paths:{"jquery-connections":t+"jquery.connections.min","jquery-timing":t+"jquery-timing.min",d3:"https://root.cern.ch/js/notebook/scripts/d3.v3.min"},shim:{"jquery-ui":{exports:"jquery.ui",deps:["jquery"]},"jquery-connections":{deps:["jquery"]},"jquery-timing":{deps:["jquery"]}}});define(["jquery","d3","jquery-ui","jquery-connections","jquery-timing"],function(t,n){return e({},t,n)})})(function(e,t,n){var i;var o={H:false,V:false,VerbosityLevel:"Default",VarTransform:"Normalize",ErrorStrategy:"CROSSENTROPY",WeightInitialization:"XAVIER",CreateMVAPdfs:false,IgnoreNegWeightsInTraining:false,SignalWeightsSum:1e3,BackgroundWeightsSum:1e3};var r=Array();var a;var l={ReLU:"layer_relu",TANH:"layer_tanh",SYMMReLU:"layer_symmrelu",SOFTSIGN:"layer_SOFTSIGN",Sigmoid:"layer_sigmoid",LINEAR:"layer_linear",GAUSS:"layer_gauss"};var u=[];var s=[];var d={layer:{input:"#00A000",output:"#F6BD00",hidden:["steelblue","red"]}};var c=n.scale.linear().domain([0,100]).range(d.layer.hidden).interpolate(n.interpolateRgb);var p=function(e){for(var t in l){if(e==l[t])return t}};var f=function(e,n){if(t("#drawConnectionHelper")[0]!==undefined){t("#drawConnectionHelper").remove()}u=[];t("#"+i).append("<div id='drawConnectionHelper'>div_"+n+"</div>");var o=t("#drawConnectionHelper");var r=t("#"+i).offset();o.css({top:e.pageY-r.top+"px",left:e.pageX-r.left+"px"});o.draggable();var a=0;o.on("click",function(){if(a==2){u.push(t(this).text());t(this).remove();a=0}else{a++}});t("#div_"+n).connections({to:"#drawConnectionHelper"})};var g=function(e,t){r[e]={type:t,neurons:0,connected:{before:null,after:null},trainingStrategy:{LearningRate:1e-5,Momentum:.3,Repetitions:3,ConvergenceSteps:100,BatchSize:30,TestRepetitions:7,WeightDecay:0,Regularization:"NONE",DropConfig:"",DropRepetitions:3,Multithreading:true}}};var v=function(e){var n;if(u.length!=1){var i=t("#drawConnectionHelper");n=String(i.text());i.remove()}else{n=String(u.pop())}t("#"+n).connections({to:"#"+e});y(n,false,false,e)};var y=function(e,t,n,i){var o=e.split("_");var a=Number(o[o.length-1]);if(t)r[a].neurons=t;if(n){o=n.split("_");var l=Number(o[o.length-1]);r[a].connected.before=l;r[l].connected.after=a}if(i){o=i.split("_");var l=Number(o[o.length-1]);r[l].connected.before=a;r[a].connected.after=l}};var _=function(e,n,o,r,l){var u=e+"_"+a++;t("#"+i).append("<div class='layer_box' id='div_"+u+"'></div>");var s=t("#div_"+u);var c=e.indexOf("input")!=-1?d.layer.input:e.indexOf("output")!=-1?d.layer.output:d.layer.hidden[0];s.css({position:"relative",top:"100px",left:"100px","z-index":90,"background-color":c});s.draggable();if(n){s.html("<input type='button' id='button_"+u+"' style='display: none;' value='0' />"+"<input type='button' id='options_"+u+"' class='button_layer' value='Options' / >"+"<span>"+p(e)+"</span>");s.on("click","#options_"+u,function(){t("#neuronnum_layer_dialog").data("buttonID",u);t("#neuronnum_layer_dialog").dialog("open")})}if(o){var y=0;s.on("click",function(e){if(y>=2){f(e,u);y=0}else{y+=1}})}if(r){s.droppable({drop:function(){v("div_"+u)}})}if(l){s.append(l)}var _=u.split("_");g(Number(_[_.length-1]),_[_.length-2])};var h=function(){t("#"+i).append("<div id='neuronnum_layer_dialog' title='Add neurons' style='display: none'>            <form>            <label>Number of neurons: </label><input type='text'>            </form>            <div id='ts_link'><input id='training_strategy_button' type='button' class='ui-button' value='Training Strategy' /></div>            </div>");t("#neuronnum_layer_dialog").dialog({autoOpen:false,show:{effect:"fade",duration:500},hide:{effect:"fade",duration:500},open:function(){t("#neuronnum_layer_dialog form input").val(t("#button_"+t(this).data("buttonID")).val())},buttons:{OK:function(){var e=t("#neuronnum_layer_dialog form input").val();var n=t("#button_"+t(this).data("buttonID"));e=Number(e);n.val(e);n.parent().css({background:c(e)});y(t(this).data("buttonID"),e);t(this).dialog("close")},Close:function(){t(this).dialog("close")}}}).data("buttonID","-1");t("#neuronnum_layer_dialog").on("click","#training_strategy_button",function(){var e=t("#trainingstrategy_dialog");e.data("formID",t("#neuronnum_layer_dialog").data("buttonID"));e.dialog("open")})};var b=function(e,t){var n="<table>";t.forEach(function(t,i){n+="<tr>";if("title"in t){n+="<td><label>"+t["title"]+"</label></td>"}else{n+="<td><label>"+i+"</label></td>"}n+="<td>";if(t["type"]=="select"){n+='<select id="'+e+"_"+i+'">';for(var o=0;o<t["options"].length;o++){n+='<option value="'+t["options"][o]+'">'+t["options"][o]+"</option>"}n+="</select>"}else{n+='<input type="'+t["type"]+'" id="'+e+"_"+i+'" />'}n+="</td>";n+="</tr>"});n+="</table>";return n};var m=function(e,n,i){for(var o in i){if(i[o]===true||i[o]===false){t("#"+e+"_"+o).prop("checked",i[o]);t("#"+e+"_"+o).change(function(){t(this).attr("value",this.checked?1:0)});if(i[o]==true){t("#"+e+"_"+o).val(1)}else{t("#"+e+"_"+o).val(0)}}else{t("#"+e+"_"+o).val(i[o])}}};var S=function(){var e=new Map;e.set("LearningRate",{type:"text"});e.set("Momentum",{type:"text"});e.set("Repetitions",{type:"text"});e.set("ConvergenceSteps",{type:"text"});e.set("BatchSize",{type:"text"});e.set("TestRepetitions",{type:"text"});e.set("WeightDecay",{type:"text"});e.set("Regularization",{type:"select",options:["NONE","L1","L2","L1MAX"]});e.set("DropConfig",{type:"text"});e.set("DropRepetitions",{type:"text"});e.set("Multithreading",{type:"checkbox"});t("#"+i).append("<div id='trainingstrategy_dialog' title='Training Strategy' style='display: none'>"+b("trainingstrategy",e)+"</div>");t("#trainingstrategy_dialog").dialog({autoOpen:false,width:400,show:{effect:"fade",duration:500},hide:{effect:"fade",duration:500},open:function(){var n=t(this).data("formID").split("_");var i=Number(n[n.length-1]);m("trainingstrategy",e,r[i].trainingStrategy)},buttons:{OK:function(){var n=t(this).data("formID").split("_");var i=Number(n[n.length-1]);n=t("#trainingstrategy_dialog input, #trainingstrategy_dialog select");var o;for(var a=0;a<n.length;a++){o=n[a].id.split("_")[1];if(e.get(o)["type"]=="checkbox"){if(Number(n[a].value)==1){r[i].trainingStrategy[o]=true}else{r[i].trainingStrategy[o]=false}}else{r[i].trainingStrategy[o]=n[a].value}}t(this).dialog("close")},Close:function(){t(this).dialog("close")}}}).data("formID","-1")};var x=function(){var e=new Map;e.set("V",{type:"checkbox",title:"Verbose"});e.set("VerbosityLevel",{type:"select",options:["Default","Debug","Verbose","Info","Warning","Error","Fatal"]});e.set("H",{type:"checkbox",title:"Help messages"});e.set("VarTransform",{type:"text"});e.set("CreateMVAPdfs",{type:"checkbox"});e.set("IgnoreNegWeightsInTraining",{type:"checkbox"});e.set("ErrorStrategy",{type:"select",options:["CROSSENTROPY","SUMOFSQUARES","MUTUALEXCLUSIVE","CHECKGRADIENTS"]});e.set("WeightInitialization",{type:"select",options:["XAVIER","XAVIERUNIFORM","LAYERSIZE"]});e.set("SignalWeightsSum",{type:"text"});e.set("BackgroundWeightsSum",{type:"text"});t("#"+i).append("<div id='globopts_dialog' title='Global options' style='display: none'>"+b("globopts",e)+"</div>");t("#globopts_dialog").dialog({autoOpen:false,width:440,show:{effect:"fade",duration:500},hide:{effect:"fade",duration:500},open:function(){m("globopts",e,o)},buttons:{OK:function(){var n=t("#globopts_dialog input, #globopts_dialog select");var i;for(var r=0;r<n.length;r++){i=n[r].id.split("_")[1];if(e.get(i)["type"]=="checkbox"){if(Number(n[r].value)==1){o[i]=true}else{o[i]=false}}else{o[i]=n[r].value}}t(this).dialog("close")},Close:function(){t(this).dialog("close")}}})};var k=function(e,n,o){t("#"+i).append("<div id='"+e+"_dialog' title='"+n+"' style='display: none'>            <p>"+o+"</p></div>");t("#"+e+"_dialog").dialog({autoOpen:false,show:{effect:"puff",duration:700},hide:{effect:"puff",duration:700},buttons:{Close:function(){t(this).dialog("close")}}});this.getID=function(){return e};this.show=function(){t("#"+e+"_dialog").dialog("open")};this.openOnClick=function(){t("#"+e).on("click",function(){t("#"+e+"_dialog").dialog("open")})};this.menuEntry=function(){return"<li class='nd_menu_element' id='"+e+"'><div>"+n+"</div></li>"}};var N=function(e){for(var t=0;t<s.length;t++){if(s[t].getID()==e)return s[t]}};var w=function(){var e="";e+="<div id='nd_menu_div'><ul id='nd_menu'>";e+="<li class='nd_menu_element'><div id='globopts_menu'>Global options</div></li>";e+="<li class='nd_menu_dropdown'><div>Add layer</div><ul class='nd_menu_dropdown_content'>";for(var n in l){e+="<li id='"+l[n]+"'><div>"+p(l[n])+"</div></li>"}e+="</ul></li>";for(var n in s){if(s[n].getID().indexOf("warning")!=-1)continue;e+=s[n].menuEntry()}e+="<li class='nd_menu_element' id='scale_layer_color'><div>Scale colors</div></li>";e+="<li class='nd_menu_element' id='save_net'><div>Save network</div></li>";e+="</ul></div>";t("#"+i).append(e)};var I=function(){var e=t(".layer_box");var n=1e20,i=-1e20;var o;for(var a=0;a<r.length;a++){o=Number(r[a].neurons);if(o<n)n=o;if(o>i)i=o}c.domain([n,i]);for(var a=0;a<e.length;a++){if(e[a].id.indexOf("input")!=-1)continue;if(e[a].id.indexOf("output")!=-1)continue;var l=e[a].getElementsByClassName("button_layer")[0].id.split("_");l=Number(l[l.length-1]);e[a].style["background-color"]=c(r[l].neurons)}};var D=function(){if(r[0].type=="input")return r[0];for(var e=0;e<r.length;e++){if(r[e].type=="input")return r[e]}console.log("Something went wrong in NetworkDesigner.getInputLayer...");return null};var O=function(e){if(e===undefined||e.type===undefined)return"";if(e.type=="output")return"";if(e.type=="input")return""+O(r[e.connected.after]);if(e.type!="input"&&e.type!="output"){return e.type.toUpperCase()+"|"+e.neurons+","+O(r[e.connected.after])}};var C=function(e){var t="";for(var n in e){if(String(e[n]).length<1)continue;t+=n+"="+String(e[n])+","}return t.substr(0,t.length-1)};var R=function(e){if(e===undefined||e.type===undefined)return"";if(e.type=="output")return"";if(e.type=="input")return""+R(r[e.connected.after]);if(e.type!="input"&&e.type!="output"){return C(e.trainingStrategy)+"|"+R(r[e.connected.after])}};var E=function(){var e="";for(var t in o){if(typeof o[t]=="boolean"){if(o[t]==true){e+=t+":"}else{e+="!"+t+":"}}else{e+=t+"="+o[t]+":"}}var n=D();var i=O(n);var r=R(n);if(i.length<2||r.length<2){N("warning_nonet").show();console.log("Layout="+i);console.log("TrainingStrategy="+r);return""}i=i.substr(0,i.length-1);r=r.substr(0,r.length-1);e+="Layout="+i+":TrainingStrategy="+r;return e};var A=function(e){t("<div>"+e.content.text+"</div>").insertAfter("#"+i)};var T=function(){var e=IPython.notebook.kernel;var t=E();if(t.length<1){return}var n={iopub:{output:A}};var i="from JsMVA.Factory import __BookDNNHelper";e.execute(i);i='__BookDNNHelper("'+t+'")';e.execute(i,n);i="del __BookDNNHelper";e.execute(i);return};var j=function(){for(var e in l){t("#"+l[e]).on("click",function(){_(t(this)[0].id,true,true,true)})}for(var n in s){s[n].openOnClick()}t("#globopts_menu").on("click",function(){t("#globopts_dialog").dialog("open")});t("#scale_layer_color").on("click",I);t("#save_net").on("click",T);t.repeat().add("connection").each(t).connections("update").wait(0)};e.draw=function(e){i=e;a=0;t("#"+i).css({"z-index":90,position:"relative"});u=[];s.push(new k("connect_layer","Connect layers","To connect two layer double click on first layer, grab the arrow and move inside the other layer."));s.push(new k("warning_nonet","No network","You didn't build a network or it's not valid. The first layer needs to connect to input layer and the last to output layer!"));w();j();_("layer_input",false,true,false,"<center>Input layer</center>");_("layer_output",false,false,true,"<center>Output layer</center>");h();S();x()};return e});